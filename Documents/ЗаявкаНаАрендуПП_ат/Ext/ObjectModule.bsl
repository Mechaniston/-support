
Перем ЭтоНовый;
Перем ЭтоТекущийСтатус;

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
			//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтатусыЗаявокНаАренду_атСрезПоследних.Статус
	|ИЗ
	|	РегистрСведений.СтатусыЗаявокНаАренду_ат.СрезПоследних КАК СтатусыЗаявокНаАренду_атСрезПоследних
	|ГДЕ
	|	СтатусыЗаявокНаАренду_атСрезПоследних.Заявка = &Заявка";
	
	Запрос.УстановитьПараметр("Заявка", ЭтотОбъект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если РезультатЗапроса.Пустой() тогда 
		
		ЭтоТекущийСтатус = Неопределено;
		
	Иначе
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			ЭтоТекущийСтатус =  ВыборкаДетальныеЗаписи.Статус;
		КонецЦикла;	
	КонецЕсли;

	
	
	ЭтоНовый = ЭтоНовый();
	
	Если ЭтоНовый Тогда
		
		УстановитьНовыйНомер();
		
	КонецЕсли;
	
	Если ПустаяСтрока(Тикет) Тогда
		
		Тикет = "П" + Строки_КлиентСервер_ат.ПолучитьНомерТикета(Номер, Дата);
		
	КонецЕсли;

	
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)

	Если ЭтоТекущийСтатус = Неопределено или ЭтоТекущийСтатус = Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаРассмотрении тогда
		
		ЗаписьСтатуса = РегистрыСведений.СтатусыЗаявокНаАренду_ат.СоздатьНаборЗаписей();
		ЗаписьСтатуса.Отбор.Заявка.Установить(ЭтотОбъект.Ссылка);
		
			НаборСведений 				= ЗаписьСтатуса.Добавить();
			НаборСведений.Заявка 		= ЭтотОбъект.Ссылка;
			НаборСведений.Период 		= ТекущаяДата();
			НаборСведений.Статус 		= Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаРассмотрении;
			НаборСведений.Пользователь 	= Пользователи.ТекущийПользователь();
			НаборСведений.Регистратор 	= ЭтотОбъект;
			
		ЗаписьСтатуса.Записать(ложь);
		
	ИначеЕсли ЭтоТекущийСтатус = Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаТехническомСогласовании тогда
		
		ЗаписьСтатуса = РегистрыСведений.СтатусыЗаявокНаАренду_ат.СоздатьНаборЗаписей();
		ЗаписьСтатуса.Отбор.Заявка.Установить(ЭтотОбъект.Ссылка);
		
			НаборСведений 				= ЗаписьСтатуса.Добавить();
			НаборСведений.Заявка 		= ЭтотОбъект.Ссылка;
			НаборСведений.Период 		= ТекущаяДата();
			НаборСведений.Статус 		= Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаТехническомСогласовании;
			НаборСведений.Пользователь 	= Пользователи.ТекущийПользователь();
			НаборСведений.Регистратор 	= ЭтотОбъект;
			
		ЗаписьСтатуса.Записать(ложь);

	ИначеЕсли ЭтоТекущийСтатус = Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаФинансовомСогласовании  тогда
				
		ЗаписьСтатуса = РегистрыСведений.СтатусыЗаявокНаАренду_ат.СоздатьНаборЗаписей();
		ЗаписьСтатуса.Отбор.Заявка.Установить(ЭтотОбъект.Ссылка);
		
			НаборСведений 				= ЗаписьСтатуса.Добавить();
			НаборСведений.Заявка 		= ЭтотОбъект.Ссылка;
			НаборСведений.Период 		= ТекущаяДата();
			НаборСведений.Статус 		= Перечисления.ТипыСтатусовЗаявокНаАренду_ат.НаФинансовомСогласовании;
			НаборСведений.Пользователь 	= Пользователи.ТекущийПользователь();
			НаборСведений.Регистратор 	= ЭтотОбъект;
			
		ЗаписьСтатуса.Записать(ложь);

	Иначе 
		Сообщить("Этот документ прошел согласование, его нельзя отменить!!!", СтатусСообщения.ОченьВажное);
		отказ = истина;
	КонецЕсли;
	
	
КонецПроцедуры




